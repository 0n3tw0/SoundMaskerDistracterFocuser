<!-- https://github.com/0n3tw0/SoundMaskerDistracterFocuser -->
<html>
<head>

<script type="text/javascript">

window.onload = function () {
    "use strict";
    var paths = document.getElementsByTagName('path');
    var visualizer = document.getElementById('visualizer');
    var mask = visualizer.getElementById('mask');
    var h = document.getElementsByTagName('h1')[0];
    var path;
    var report = 0;
	
	var tones=[
		new Audio('12000-2.mp3'),
		new Audio('10000-2.mp3'),
		new Audio('12000-2.mp3'),
		new Audio('10000-2.mp3'),

		new Audio('12000-2.mp3'),
		new Audio('8000-2.mp3'),
		new Audio('12000-2.mp3'),
		new Audio('8000-2.mp3'),

		new Audio('15000-2.mp3'),
		new Audio('14000-2.mp3'),

		new Audio('14000-2.mp3'),
		new Audio('12000-2.mp3'),
		new Audio('14000-2.mp3'),
		new Audio('12000-2.mp3'),

		new Audio('14000-2.mp3'),
		new Audio('8000-2.mp3'),
		new Audio('14000-2.mp3'),
		new Audio('8000-2.mp3'),
		
		new Audio('15000-2.mp3'),
		new Audio('12000-2.mp3'),

		new Audio('8000-2.mp3'),
		new Audio('10000-2.mp3'),
		new Audio('8000-2.mp3'),
		new Audio('10000-2.mp3')
	];
	var tones2=[
		new Audio('12000.mp3'),
		new Audio('10000.mp3'),
		new Audio('12000.mp3'),
		new Audio('10000.mp3'),

		new Audio('12000.mp3'),
		new Audio('8000.mp3'),
		new Audio('12000.mp3'),
		new Audio('8000.mp3'),

		new Audio('15000.mp3'),
		new Audio('14000.mp3'),

		new Audio('14000.mp3'),
		new Audio('12000.mp3'),
		new Audio('14000.mp3'),
		new Audio('12000.mp3'),

		new Audio('14000.mp3'),
		new Audio('8000.mp3'),
		new Audio('14000.mp3'),
		new Audio('8000.mp3'),
		
		new Audio('15000.mp3'),
		new Audio('12000.mp3'),

		new Audio('8000.mp3'),
		new Audio('10000.mp3'),
		new Audio('8000.mp3'),
		new Audio('10000.mp3')
	];
	var currentTone=tones[0];
	var currentTonePlayedAt=0;
	var maxAmplitude=2000;
	var maxHistory=[0];
	var intervalPlay=20;
	var lastTones=[];
    
    var soundAllowed = function (stream) {
        //Audio stops listening in FF without // window.persistAudioStream = stream;
        //https://bugzilla.mozilla.org/show_bug.cgi?id=965483
        //https://support.mozilla.org/en-US/questions/984179
        window.persistAudioStream = stream;
        h.innerHTML = "Thanks";
        h.setAttribute('style', 'opacity: 0;');
        var audioContent = new AudioContext();
        var audioStream = audioContent.createMediaStreamSource( stream );
        var analyser = audioContent.createAnalyser();
        audioStream.connect(analyser);
        analyser.fftSize = 1024;

        var frequencyArray = new Uint8Array(analyser.frequencyBinCount);
        visualizer.setAttribute('viewBox', '0 0 255 255');
      
		//Through the frequencyArray has a length longer than 255, there seems to be no
        //significant data after this point. Not worth visualizing.
        for (var i = 0 ; i < 255; i++) {
            path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('stroke-dasharray', '4,1');
            mask.appendChild(path);
        }
        var doDraw = function () {

            requestAnimationFrame(doDraw);
            analyser.getByteFrequencyData(frequencyArray);
          	var adjustedLength;
			
			var amplitude=0;
			var ampTone=[];
			
			var cutoff=Math.floor(Math.random()*40);

            for (var i = 0 ; i < 255; i++) {
			
              	adjustedLength = Math.floor(frequencyArray[i]) - (Math.floor(frequencyArray[i]) % 5);

                paths[i].setAttribute('d', 'M '+ (i) +',255 l 0,-' + adjustedLength);

				if(!ampTone[i%tones.length]){
					ampTone.push(0);
				}
				if(i<cutoff){
					ampTone[i%tones.length]+=0;
				}else{
					amplitude+=adjustedLength;
					ampTone[i%tones.length]+=adjustedLength;//(adjustedLength*.75)+(Math.random()*(adjustedLength));
				}

            }
			
			if(Math.random()<.25){
				ampTone=ampTone.reverse();
			}

			var toneI=Math.floor(Math.random()*tones.length);
			var ampToneMax=0;
			
			for(i=0;i<ampTone.length;i++){
				if(ampTone[i]&&ampTone[i]>ampToneMax&&Math.random()<.25){
					ampToneMax=ampTone[i];
					toneI=i;
					if(Math.random()<.01){
						return;
					}
				}
			}
			if(!tones[toneI]){
				return;
			}

			var timestampSeconds=Date.now();

			if(timestampSeconds-currentTonePlayedAt>intervalPlay){
			
				maxHistory[0]+=amplitude;
				//if(amplitude>maxAmplitude/2){
					maxHistory.push(amplitude);
				//}
				if(maxHistory.length>20){
					maxAmplitude=maxHistory[0]/maxHistory.length;
					console.log(maxAmplitude);
					maxHistory=[0];
				}
				
				amplitude-=1000;
				amplitude=amplitude/maxAmplitude;
				
				//amplitude+=(-.1+(Math.random()*.2));
				if(amplitude<0){
					amplitude=0;
				}
				if(amplitude>=1){
					amplitude=.99999;
				}
				
				//amplitude=amplitude;
				if(currentTone){
					setTimeout(function(){
						while(lastTones.length>10-Math.floor(Math.random()*7)){
							lastTones[0].pause();
							lastTones.shift();
						}
					},100+Math.floor(Math.random()*1900));
					
				}

				if(Math.random()<.9){
					currentTone=tones[toneI];
					lastTones.push(tones[toneI]);
				}else{
					currentTone=tones2[toneI];
					lastTones.push(tones2[toneI]);
				}
				
				if(amplitude<.6){
					amplitude+=Math.random()*.2;
				}
				
				currentTone.volume=amplitude;
				currentTone.loop=true;
				
				if(Math.random()<.1){
					
				}else{
					currentTone.play();
				}
				
				currentTonePlayedAt=timestampSeconds;//+Math.floor((Math.random()*intervalPlay)/1);
				
				//console.log(currentTone.volume);
				
			}
			

        }
        doDraw();
    }

    var soundNotAllowed = function (error) {
        h.innerHTML = "You must allow your microphone.";
        console.log(error);
    }

    /*window.navigator = window.navigator || {};
    /*navigator.getUserMedia =  navigator.getUserMedia       ||
                              navigator.webkitGetUserMedia ||
                              navigator.mozGetUserMedia    ||
                              null;*/
    navigator.getUserMedia({audio:true}, soundAllowed, soundNotAllowed);

};

</script>
<style>
html, body{
width: 100%;
height: 100%;
padding: 0;
margin: 0;
background-color:#222;
font-size: 0;
}

svg{
display: block;
width: 100%;
height: 100%;
padding: 0;
margin: 0;
position:absolute;

}

h1{
width: 100%;
font-family: sans-serif;
position:absolute;
text-align:center;
color:white;
font-size: 18px;
top: 40%;
opacity: 1;
transition: opacity 1s ease-in-out;
-moz-transition: opacity 1s ease-in-out;
-webkit-transition: opacity 1s ease-in-out;
}

h1 a{
  color: #48b1f4;
  text-decoration:none;
}

path{
stroke-linecap: square;
stroke: white;
stroke-width: 0.5px;
}
</style>

</head>
<body>

        <svg preserveAspectRatio="none" id="visualizer" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <defs>

                <mask id="mask">
                    <g id="maskGroup">
                  </g>
                </mask>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ff0a0a;stop-opacity:1" />
                    <stop offset="20%" style="stop-color:#f1ff0a;stop-opacity:1" />
                    <stop offset="90%" style="stop-color:#d923b9;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#050d61;stop-opacity:1" />
                </linearGradient>
            </defs>
            <rect x="0" y="0" width="100%" height="100%" fill="url(#gradient)" mask="url(#mask)"></rect>
        </svg>

<h1>In <a href="https://codepen.io/zapplebee/full/gbNbZE/">Full Page view</a>, please allow the use of your microphone</h1>

</body>
</html>
